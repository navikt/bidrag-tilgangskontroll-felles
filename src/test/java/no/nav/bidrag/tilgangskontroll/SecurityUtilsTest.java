package no.nav.bidrag.tilgangskontroll;

import static org.assertj.core.api.Assertions.assertThat;

import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.junit.jupiter.MockitoExtension;

@ExtendWith(MockitoExtension.class)
public class SecurityUtilsTest {

  private static String issoUser = "eyAidHlwIjogIkpXVCIsICJraWQiOiAiMWwySmtDb1RMMTBibWVBeHlsZzR4Umk4ajJZPSIsICJhbGciOiAiUlMyNTYiIH0.eyAiYXRfaGFzaCI6ICJmX25XQTAzbkpDRTd1bHA2cVdpYWtnIiwgInN1YiI6ICJaOTk0OTc3IiwgImF1ZGl0VHJhY2tpbmdJZCI6ICIxY2M4ZmQ1My00NjE0LTQyN2UtYTAxOS04NDZmOTI0YzBjMDEtNDU0NzczMSIsICJpc3MiOiAiaHR0cHM6Ly9pc3NvLXEuYWRlby5ubzo0NDMvaXNzby9vYXV0aDIiLCAidG9rZW5OYW1lIjogImlkX3Rva2VuIiwgImF1ZCI6ICJiaWRyYWctdWktZmVhdHVyZS1xMSIsICJvcmcuZm9yZ2Vyb2NrLm9wZW5pZGNvbm5lY3Qub3BzIjogImRhMzkzZDJmLWJjMWQtNDdmZS1iYjE0LWQ2MTdiNGU2MTNiMyIsICJhenAiOiAiYmlkcmFnLXVpLWZlYXR1cmUtcTEiLCAiYXV0aF90aW1lIjogMTY1NTQ3Mjk0NiwgInJlYWxtIjogIi8iLCAiZXhwIjogMTY1NTQ3NjU0NiwgInRva2VuVHlwZSI6ICJKV1RUb2tlbiIsICJpYXQiOiAxNjU1NDcyOTQ2IH0.GD34dn-_suqXWxweGPBnjc4XK4hrT3upivivTlen4jvFC_TfydcWEsTv2SSHL4CRqT6Uy7j1Q22XepzdjmUn31qQXpWQzygGTYvYKy0HJM7AFBJ-pbTuVvniUVyaP2HLmSTCc5vFIs4kvlqWqv0e8afMkKo97-VKAWCSkWP7ZkFavq6D6uxHpZ2IJch0VNT9stSnEKFkyv1ELZnaWuFZcgTqHEUmEdlljpP9dv8zgSwQmkQsspPowwfTTFhE17yK65KAXo_Zavtg_TTSl_Nt2FCwrnC-qBXL8DJF7SKAEUF7JacZlSKWCRJCLaXBnNpp3tdoQLQzLIvkRL9xDh8V1w";
  private static String stsToken = "eyJraWQiOiIyMmI5ZjFjMC05MThiLTRkODEtYTQ4YS05ODJhZDIyMjdkYzkiLCJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJzdWIiOiJzcnZiaXN5cyIsImF1ZCI6WyJzcnZiaXN5cyIsInByZXByb2QubG9jYWwiXSwidmVyIjoiMS4wIiwibmJmIjoxNjU1NDc2ODE2LCJhenAiOiJzcnZiaXN5cyIsImlkZW50VHlwZSI6IlN5c3RlbXJlc3N1cnMiLCJhdXRoX3RpbWUiOjE2NTU0NzY4MTYsImlzcyI6Imh0dHBzOlwvXC9zZWN1cml0eS10b2tlbi1zZXJ2aWNlLm5haXMucHJlcHJvZC5sb2NhbCIsImV4cCI6MTY1NTQ4MDQxNiwiaWF0IjoxNjU1NDc2ODE2LCJqdGkiOiJlMTA0YzdkMy1hYmNjLTRhMmUtOWZjOS05ZDU0NjQ0OTRjODkifQ.RF2nzUB7mWp-SIX0K7B9HGiqSw4XBCpHdW9UPq51ir484NCnpobNt1CIRup_76Lw-78_Fx8FMpRvWdXvYwhe99tnT5210vMkR9-s0gtuag5JHVG1KXaiJm-huDeRbU5EgU9bvK6S8qndfBkwl383GHxHjdPpIxRyPWpzsV2OXm9rl7qL8g6m7QzOrbkslfoskoBkPbRWRwWRGY-RqBhWdDdDHFdh3HpbfvkHmVqzDT_uAAfabpcv11fyhw-ceInELz5ZhBn4PfAAGFD9JHwgFHYsYAos-MNy-4dBvm0cz9Q1A7O6zjFG-Fu8mm8JXhN7PxDHln7n_M_vEvIxFndmjA";
  private static String azureSystemToken = "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImtpZCI6ImpTMVhvMU9XRGpfNTJ2YndHTmd2UU8yVnpNYyJ9.eyJhdWQiOiI0MjdiMDAyNi01M2Q1LTQ4ZjktYmU5Ny05OWM3ZmM3NGYwOWEiLCJpc3MiOiJodHRwczovL2xvZ2luLm1pY3Jvc29mdG9ubGluZS5jb20vOTY2YWM1NzItZjViNy00YmJlLWFhODgtYzc2NDE5YzBmODUxL3YyLjAiLCJpYXQiOjE2NTU3OTcyNTUsIm5iZiI6MTY1NTc5NzI1NSwiZXhwIjoxNjU1ODAxMTU1LCJhaW8iOiJFMlpnWUZoemxJOUI3MlcxMGFUbDdXbVMxOTk5QndBPSIsImF6cCI6ImQyMjBlMjg0LWMwZjAtNDNmMS1hNTg1LTVjNWI1YzYzZGMwYSIsImF6cGFjciI6IjEiLCJvaWQiOiI3ZTRlMTkzOS0wYzIxLTRhNzgtYmNhNy0yMTk3M2UwYzQ2YjEiLCJyaCI6IjAuQVVjQWNzVnFscmYxdmt1cWlNZGtHY0Q0VVNZQWUwTFZVX2xJdnBlWnhfeDA4SnBIQUFBLiIsInJvbGVzIjpbImFjY2Vzc19hc19hcHBsaWNhdGlvbiJdLCJzdWIiOiI3ZTRlMTkzOS0wYzIxLTRhNzgtYmNhNy0yMTk3M2UwYzQ2YjEiLCJ0aWQiOiI5NjZhYzU3Mi1mNWI3LTRiYmUtYWE4OC1jNzY0MTljMGY4NTEiLCJ1dGkiOiIzLTN3SV9kRV9rV0ZlTHJrUWJsT0FBIiwidmVyIjoiMi4wIiwiYXpwX25hbWUiOiJkZXYtZnNzOmJpZHJhZzpiaWRyYWctZG9rdW1lbnQtZmVhdHVyZSJ9.OCPzUfIsGEfwR4Xfy8Zk2kyKHyOS1lCeWKedeVM7CsM-OvzaTARDnpGmI-ioeHYuwFmfW5HjftEg2dDsghY240JeRnF_NlOZ_ln8UKk1bdbdvW2uXQygVcOxGIrBAjX46Ec3qF000x-mgXhsCQdQiUwSYLEeeagZyDNJpzgL3tdtn4ykxg3qFg32s2ppnSbWIXe4g53ytr7-jildz34JJhlHewvYrbdAIA7ANBsd80UDDmGmnpzM0UzeeYRdtyemn4N26k7bbvpcuySfVL5RQ-9XDfvfzF2Dx4uLyx6_wai5E1osBNzgGyd8XS3Rh_D92fsBQzALVERdU9_ziViMDA";
  private static String azureUserToken = "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImtpZCI6ImpTMVhvMU9XRGpfNTJ2YndHTmd2UU8yVnpNYyJ9.eyJhdWQiOiJkMjIwZTI4NC1jMGYwLTQzZjEtYTU4NS01YzViNWM2M2RjMGEiLCJpc3MiOiJodHRwczovL2xvZ2luLm1pY3Jvc29mdG9ubGluZS5jb20vOTY2YWM1NzItZjViNy00YmJlLWFhODgtYzc2NDE5YzBmODUxL3YyLjAiLCJpYXQiOjE2NTU0NzI1NTIsIm5iZiI6MTY1NTQ3MjU1MiwiZXhwIjoxNjU1NDc2NjUxLCJhaW8iOiJBVFFBeS84VEFBQUFvaUgzVWduQW1nTWRmZkE5T1oxYkV3d05HTmVkRTRObVpad0RzQngrTTNxbUVicDVwYWVzTlFsSktyMm9rS1Z0IiwiYXpwIjoiNDJhYTEyMGItYmNhMi00YjkzLWJhMzQtNTA3NDQ5YTg0MzdkIiwiYXpwYWNyIjoiMiIsImdyb3VwcyI6WyJkZWMzZWU1MC1iNjgzLTQ2NDQtOTUwNy01MjBlOGYwNTRhYzIiXSwibmFtZSI6IkZfWjk5NDk3NyBFX1o5OTQ5NzciLCJvaWQiOiJhN2VjOGE3ZC00YmE4LTQ3NmEtOGVmYS02YjliMWIzYjA3ZjQiLCJwcmVmZXJyZWRfdXNlcm5hbWUiOiJGX1o5OTQ5NzcuRV9aOTk0OTc3QHRyeWdkZWV0YXRlbi5ubyIsInJoIjoiMC5BVWNBY3NWcWxyZjF2a3VxaU1ka0djRDRVWVRpSU5Md3dQRkRwWVZjVzF4ajNBcEhBT3cuIiwic2NwIjoiZGVmYXVsdGFjY2VzcyIsInN1YiI6IlVqTlBIRlFFUnRLWERvaFg0eF9jZEV3Q2Z6eUdka1hVdlZqaG1obVRJZUEiLCJ0aWQiOiI5NjZhYzU3Mi1mNWI3LTRiYmUtYWE4OC1jNzY0MTljMGY4NTEiLCJ1dGkiOiItdlo2aDNVcUNrMmZNcHdlcWkyMUFBIiwidmVyIjoiMi4wIiwiTkFWaWRlbnQiOiJaOTk0OTc3IiwiYXpwX25hbWUiOiJkZXYtZnNzOmJpZHJhZzpiaWRyYWctdWktZmVhdHVyZSJ9.DdAIxFnkgPEz31ttObnr-jMM8EWV97XGNdWU2KJaU_hb58HYSl4Dj-VruO1EE1L9EpUG2o89i10GsnsCIvsIOkCfZYqb06RG2675IbVOl594eXxwoX2CcS-P2PCaqRxLOuFEDADWVoC6rmvCydHld3SxrNLYS03__NBhZ9VYzYYxy1rkF_GaLCVPSN0yXxAGkYbTv1IX41RXrqzYPLnPH_asg9RbTKi0qxOtywZilrEtrQFnfcldzZfaisfG49oX_Kp4Qxhstlens4zkbKYcoz4Y52crSbYUXL2R_iUVIXe0zrnbmQ3hXhjEvTaGiquWCVya_SJbxsj8W9Eh7cxccQ";

  @Test
  void skalHentePidFraToken() {

    // given
    var testident = "03827297045";
    var testIdtoken = "eyJraWQiOiJ2UHBaZW9HOGRkTHpmdHMxLWxnc3VnOHNyYVd3bW04dHhJaGJ3Y1h3R01JIiwiYWxnIjoiUlMyNTYifQ.eyJzdWIiOiJkTEJSelptWE1qNENXSkU1RWlHZHJLNDctM0VnSlFOZER0SEgwbkJ5d0RJPSIsImlzcyI6Imh0dHBzOlwvXC9vaWRjLXZlcjIuZGlmaS5ub1wvaWRwb3J0ZW4tb2lkYy1wcm92aWRlclwvIiwiY2xpZW50X2FtciI6ImNsaWVudF9zZWNyZXRfcG9zdCIsInBpZCI6IjAzODI3Mjk3MDQ1IiwidG9rZW5fdHlwZSI6IkJlYXJlciIsImNsaWVudF9pZCI6ImQ4Mjk3MjQwLTIzYzgtNDBjOC1iMWM4LWEyOTNhZjczNjk3MiIsImF1ZCI6Imh0dHBzOlwvXC9uYXYubm8iLCJhY3IiOiJMZXZlbDQiLCJzY29wZSI6Im9wZW5pZCIsImV4cCI6MTY1MTQ4ODk2MSwiaWF0IjoxNjUxNDg1MzYxLCJjbGllbnRfb3Jnbm8iOiI4ODk2NDA3ODIiLCJqdGkiOiJDbC1KaTJRUjMwenV6Y2ZSdGJiLV9WRUlqbHNlc2VPekR0VzNhQzZ3eVNBIiwiY29uc3VtZXIiOnsiYXV0aG9yaXR5IjoiaXNvNjUyMy1hY3RvcmlkLXVwaXMiLCJJRCI6IjAxOTI6ODg5NjQwNzgyIn19.M-ra4lqxARFNItFolFxKdbw1-IYZzlUzqmWrq89Z09wnNlxycHc_03wJnIrYCsSQgwk-rUV20k-boQDfauDJM8Cq1DLmH-GMHx3LH0bAwi8KZI3EN57GsCePtMF-WSDKJ2o5Ny_b5_z6SANeZ6LbKVsIP_2Z6pQKni5_CbWlNzFEZ35QPQnF_9DOO_549GXIPLK6Bk1mfiG_95nunfD1JPQB_WZ-zWNd3VXEBnmSXnJqMIj0VM7GHykSRD5s4mj8NjDWVLmu82ag2c70mt0ebEopUvBRjbWZE2CMBKuJIxmzjFVaXwmXDOp-MXz7Nsw-LJ1F0qUvFhfoFykpAPxTzQ";

    // when
    var pid = SecurityUtils.hentePid(testIdtoken);

    // then
    assertThat(pid).isEqualTo(testident);
  }

  @Test
  void skalHenteSubjectFraAzureSystemToken() {

    var subject = SecurityUtils.henteSubject(azureSystemToken);

    // then
    assertThat(subject).isEqualTo("bidrag-dokument-feature");
  }

  @Test
  void skalHenteSubjectFraAzureToken() {

    var subject = SecurityUtils.henteSubject(azureUserToken);

    // then
    assertThat(subject).isEqualTo("Z994977");
  }

  @Test
  void skalHenteSubjectFraIssoToken() {

    var subject = SecurityUtils.henteSubject(issoUser);

    // then
    assertThat(subject).isEqualTo("Z994977");
  }

  @Test
  void shouldValidateSystemToken() {

    // when
    var resultAzure = SecurityUtils.isSystemUser(azureSystemToken);
    var resultSTS = SecurityUtils.isSystemUser(stsToken);
    var resultAzureUser = SecurityUtils.isSystemUser(azureUserToken);
    var resultIsso = SecurityUtils.isSystemUser(issoUser);

    // then
    assertThat(resultAzure).isTrue();
    assertThat(resultSTS).isTrue();
    assertThat(resultAzureUser).isFalse();
    assertThat(resultIsso).isFalse();
  }

  @Test
  void shouldGetNavUserIdent() {

    // given
    var azureUserToken = "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImtpZCI6ImpTMVhvMU9XRGpfNTJ2YndHTmd2UU8yVnpNYyJ9.eyJhdWQiOiJkMjIwZTI4NC1jMGYwLTQzZjEtYTU4NS01YzViNWM2M2RjMGEiLCJpc3MiOiJodHRwczovL2xvZ2luLm1pY3Jvc29mdG9ubGluZS5jb20vOTY2YWM1NzItZjViNy00YmJlLWFhODgtYzc2NDE5YzBmODUxL3YyLjAiLCJpYXQiOjE2NTU0NzI1NTIsIm5iZiI6MTY1NTQ3MjU1MiwiZXhwIjoxNjU1NDc2NjUxLCJhaW8iOiJBVFFBeS84VEFBQUFvaUgzVWduQW1nTWRmZkE5T1oxYkV3d05HTmVkRTRObVpad0RzQngrTTNxbUVicDVwYWVzTlFsSktyMm9rS1Z0IiwiYXpwIjoiNDJhYTEyMGItYmNhMi00YjkzLWJhMzQtNTA3NDQ5YTg0MzdkIiwiYXpwYWNyIjoiMiIsImdyb3VwcyI6WyJkZWMzZWU1MC1iNjgzLTQ2NDQtOTUwNy01MjBlOGYwNTRhYzIiXSwibmFtZSI6IkZfWjk5NDk3NyBFX1o5OTQ5NzciLCJvaWQiOiJhN2VjOGE3ZC00YmE4LTQ3NmEtOGVmYS02YjliMWIzYjA3ZjQiLCJwcmVmZXJyZWRfdXNlcm5hbWUiOiJGX1o5OTQ5NzcuRV9aOTk0OTc3QHRyeWdkZWV0YXRlbi5ubyIsInJoIjoiMC5BVWNBY3NWcWxyZjF2a3VxaU1ka0djRDRVWVRpSU5Md3dQRkRwWVZjVzF4ajNBcEhBT3cuIiwic2NwIjoiZGVmYXVsdGFjY2VzcyIsInN1YiI6IlVqTlBIRlFFUnRLWERvaFg0eF9jZEV3Q2Z6eUdka1hVdlZqaG1obVRJZUEiLCJ0aWQiOiI5NjZhYzU3Mi1mNWI3LTRiYmUtYWE4OC1jNzY0MTljMGY4NTEiLCJ1dGkiOiItdlo2aDNVcUNrMmZNcHdlcWkyMUFBIiwidmVyIjoiMi4wIiwiTkFWaWRlbnQiOiJaOTk0OTc3IiwiYXpwX25hbWUiOiJkZXYtZnNzOmJpZHJhZzpiaWRyYWctdWktZmVhdHVyZSJ9.DdAIxFnkgPEz31ttObnr-jMM8EWV97XGNdWU2KJaU_hb58HYSl4Dj-VruO1EE1L9EpUG2o89i10GsnsCIvsIOkCfZYqb06RG2675IbVOl594eXxwoX2CcS-P2PCaqRxLOuFEDADWVoC6rmvCydHld3SxrNLYS03__NBhZ9VYzYYxy1rkF_GaLCVPSN0yXxAGkYbTv1IX41RXrqzYPLnPH_asg9RbTKi0qxOtywZilrEtrQFnfcldzZfaisfG49oX_Kp4Qxhstlens4zkbKYcoz4Y52crSbYUXL2R_iUVIXe0zrnbmQ3hXhjEvTaGiquWCVya_SJbxsj8W9Eh7cxccQ";

    assertThat(SecurityUtils.hentSubjectIdFraAzureToken(azureUserToken)).isEqualTo("Z994977");
  }
}
